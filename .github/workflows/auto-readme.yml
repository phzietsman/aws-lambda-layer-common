name: "auto-readme"
on:
  schedule:
  # Example of job definition:
  # .---------------- minute (0 - 59)
  # |  .------------- hour (0 - 23)
  # |  |  .---------- day of month (1 - 31)
  # |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...
  # |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat
  # |  |  |  |  |
  # *  *  *  *  * user-name command to be executed

  # Update README.md nightly at 4am UTC
  - cron:  '0 4 * * *'

env:
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - name: Set up Python üêç
      uses: actions/setup-python@v1
      with:
        python-version: 3.9

    - name: New Reame üì¶
      run: |
        cp -nf README.template README.md

    - name: "Update readme [common-python-libraries] üìñ"
      run: |
        for region in us-east-2 us-east-1 us-west-1 us-west-2 af-south-1 ap-east-1 ap-southeast-3 ap-south-1 ap-northeast-3 ap-northeast-2 ap-southeast-1 ap-southeast-2 ap-northeast-1 ca-central-1 eu-central-1 eu-west-1 eu-west-2 eu-south-1 eu-west-3 eu-north-1 me-south-1 sa-east-1
        do
        LAYER_VERSION=$(aws lambda list-layer-versions \
          --layer-name common-python-libraries 
          --region $region \
          --query 'LayerVersions[0].LayerVersionArn')
        
        sed -i -e "s/%%$region%%common-python-libraries%%/$LAYER_VERSION_ARN/g" "./README.md"

        done

    - name: Push README üìå
      uses: stefanzweifel/git-auto-commit-action@v4
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        commit_message: Update python lambda layer
        branch: main
        commit_user_name: python-layer ü§ñ
        commit_user_email: actions@github.com
        commit_author: python-layer ü§ñ <actions@github.com>